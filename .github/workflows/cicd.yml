name: CI/CD

on:
  push:
    branches:
      - main

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: true

env:
  BACK_REPO: ${{ secrets.DOCKER_USERNAME }}/booking_service_backend
  CELERY_REPO: ${{ secrets.DOCKER_USERNAME }}/booking_service_celery
  IMAGE_TAG: ${{ github.sha }}

jobs:

  build-and-push:
    name: Build & Push images to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push APP image
        uses: docker/build-push-action@v6
        with:
          context: ./src
          file: ./src/Dockerfile.app
          push: true
          tags: |
            ${{ env.BACK_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.BACK_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push CELERY image
        uses: docker/build-push-action@v6
        with:
          context: ./src
          file: ./src/Dockerfile.celery
          push: true
          tags: |
            ${{ env.CELERY_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.CELERY_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Server via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy docker-compose.production.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "docker-compose.production.yml"
          target: "booking_service"
          strip_components: 1
          overwrite: true

      - name: Executing remote ssh commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd booking_service

            cat > .deploy.env <<'EOF'
            APP_IMAGE=${{ env.BACK_REPO }}:${{ env.IMAGE_TAG }}
            CELERY_IMAGE=${{ env.CELERY_REPO }}:${{ env.IMAGE_TAG }}
            EOF

            COMPOSE=docker-compose.production.yml

            sudo docker compose --env-file .deploy.env -f $COMPOSE pull
            sudo docker compose --env-file .deploy.env -f $COMPOSE up -d --remove-orphans
            sudo docker compose --env-file .deploy.env -f $COMPOSE exec -T app alembic upgrade head || true
            sudo docker system prune -f
