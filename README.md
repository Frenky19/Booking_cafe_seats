# Система бронирования мест в кафе

Cистема для управления бронированиями столов в кафе с REST API, уведомлениями и ролевой моделью доступа.

https://yamdb.ru/docs

## Функциональные возможности

### Основной функционал
- **Управление пользователями** - регистрация, аутентификация, ролевая модель
- **Бронирование столов** - выбор даты, времени, столов с валидацией
- **Управление кафе** - создание и редактирование кафе, столов, временных слотов
- **Уведомления** - email-уведомления о бронированиях и напоминания
- **Медиа-файлы** - загрузка и хранение изображений

### Ролевая модель
- **Пользователь** - бронирование столов, просмотр меню и акций
- **Менеджер** - управление своим кафе, просмотр бронирований
- **Администратор** - полный доступ ко всем функциям системы

## Технологический стек

### Backend
- **Python 3.12** - основной язык программирования
- **FastAPI** - современный асинхронный фреймворк
- **SQLAlchemy 2.0** - ORM для работы с базой данных
- **Alembic** - управление миграциями базы данных
- **Pydantic** - валидация данных и сериализация

### Базы данных и кеширование
- **PostgreSQL** - основная реляционная база данных
- **Redis** - кеширование меню и акций

### Фоновая обработка
- **Celery** - асинхронная обработка задач
- **RabbitMQ** - брокер сообщений для Celery
- **Flower** - мониторинг Celery задач

### Контейнеризация
- **Docker** - контейнеризация приложения
- **Docker Compose** - оркестрация сервисов

## Установка и запуск

### Предварительные требования
- Docker
- Python 3.12

### Запуск

1. Клонируйте репозиторий:

```
git clone <repository_url>
cd <project_name>
```

2. Настройте переменные окружения:

```
cd infra
cp .env.example .env
# Отредактируйте .env файл по необходимости
```

3. Установите poetry глобально:

- Для Linux:
```
curl -sSL https://install.python-poetry.org | python3 -
```

- Для Windows (PowerShell):
```
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python
```

4. Чтобы виртуальное окружение создавалось в директории проекта создавалось в директории проекта - выполните команду:

```
poetry config virtualenvs.in-project true
```

5. Выполните команду для чтобы явно указать какой интерпретатор Python будет использоваться
для создания виртуального окружения в рамках проекта:

```
poetry env use python3.12
```
(если у вас Python 3.12 установлен глобально в системе)
Или вместо `python3.12` укажите путь к вашему интерпретатору Python 3.12

6. Установите зависимости:

```
cd src
poetry install --with dev
```

7. Настройте pre-commit хуки:

```
poetry run pre-commit install
```

8. Запустите сервисы через Docker:

```
cd infra
docker compose up -d
```

9. Примените миграции базы данных:

```
poetry run alembic revision --autogenerate -m "комментарий к миграции"
poetry run alembic upgrade head
```

10. Запустите приложение:

```
cd src
poetry run uvicorn app.main:app --reload
```

Приложение будет доступно по адресу: http://localhost:8000

## API Документация

После запуска приложения доступны следующие интерфейсы:

| Интерфейс | URL | Назначение |
|-----------|-----|------------|
| Swagger UI | http://localhost:8000/docs | Интерактивная документация API |
| ReDoc | http://localhost:8000/redoc | Альтернативная документация |
| Flower | http://localhost:5555 | Мониторинг задач Celery |

## Основные эндпоинты

### Аутентификация

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| `POST` | `/auth/login` | Получение JWT токена |
| `GET` | `/users/me` | Информация о текущем пользователе |

### Пользователи

| Метод | Эндпоинт | Описание | Доступ |
|-------|----------|----------|---------|
| `POST` | `/users` | Регистрация нового пользователя | Публичный |
| `GET` | `/users` | Список пользователей | Админы/Менеджеры |
| `PATCH` | `/users/{user_id}` | Обновление пользователя | Владелец/Админ |

### Кафе и бронирования

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| `GET` | `/cafes` | Список кафе |
| `POST` | `/cafes` | Создание кафе |
| `GET` | `/cafe/{cafe_id}/tables` | Столы конкретного кафе |
| `POST` | `/booking` | Создание бронирования |
| `PATCH` | `/booking/{booking_id}` | Обновление бронирования |

### Медиа

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| `POST` | `/media` | Загрузка изображений |
| `GET` | `/media/{media_id}` | Получение изображения |

## Аутентификация

Система использует JWT токены для аутентификации. Для доступа к защищенным эндпоинтам необходимо:

1. Получить токен через `/auth/login`
2. Добавить заголовок: `Authorization: Bearer <token>`

### Пример запроса аутентификации:

```
curl -X POST "http://localhost:8000/auth/login" \
     -H "Content-Type: application/json" \
     -d '{"login": "user@example.com", "password": "password"}'
```

# Бизнес-правила

## Бронирования

### Правила валидации
- **Запрет бронирования на прошлое** - нельзя бронировать на прошедшие даты
- **Контроль пересечений** - бронирования не должны пересекаться по времени
- **Ограничение изменений** - нельзя изменить завершенные или активные бронирования
- **Лимит гостей** - минимальное количество гостей: 1, максимальное: вместимость выбранных столов

## Уведомления

### Система оповещений
- **Создание брони** - уведомления отправляются пользователю и менеджерам кафе при создании бронирования
- **Изменения брони** - уведомления отправляются при изменении бронирования
- **Напоминания** - можно настроить напоминания за N минут до бронирования

# Структура базы данных

## Основные сущности системы

| Сущность | Описание |
|----------|-----------|
| **users** | Пользователи системы |
| **cafes** | Информация о кафе |
| **tables** | Столы для бронирования |
| **slots** | Временные интервалы бронирования |
| **booking** | Информация о бронированиях |
| **dishes** | Блюда меню |
| **actions** | Акции и специальные предложения |

#  Разработчики

- [Николай Климко / Nikolay Klimko](https://github.com/KKolyasik)
- [Андрей Головушкин / Andrey Golovushkin](https://github.com/Frenky19)
- [Валерий Абрамов / Valeriy Abramov](https://github.com/abramov-v)
- [Татьяна Попова / Tatiana Popova](https://github.com/tpopova13x)
- [Никита Шмаков / Nikita Shmakov](https://github.com/Shm-nikita)
- [Антон Авельев / Anton Avelyev](https://github.com/anton-avelyev)
